<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <link href="style.css" rel="stylesheet">
</head>
<script>
    opened = false;
</script>

<body>
    <div class="col-lg-5"></div>
    <div class="col-lg-1">
        <button style="margin:7px 15px 17px 0; position:center center;" class="btn btn-info btn-lg span12" onClick="openForm()">Click To Open Modal</button>
    </div>
    <div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Export preferences</h4>
                </div>
                <form id="myForm" class="col-lg-12" action="export.php" method="get">

                    <!-- form for predefined types -->
                    <div class="form-horizontal">
                        <div class="container">
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="col-lg-3" style="width:auto; margin-top:10px; margin-left:-15px;">
                                        Format preference:
                                    </div>
                                    <div class="btn-group btn-group-horizontal" data-toggle="buttons">

                                        <label id="europelbl" onclick="hidde('europe')" class="formatPreflbl btn"><input type="radio" onclick="hidde('europe')" id="europe" class="formatPref radio-inline"  name="formatPref" value="europe"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Europe</label>

                                        <label id="usalbl" onclick="hidde('usa')" class="formatPreflbl btn"><input type="radio" id="usa" onclick="hidde('usa')" class="formatPref radio-inline"  name="formatPref" value="usa" checked><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>USA</label>

                                        <label id="customlbl" onclick="show()" class="formatPreflbl btn"><input type="radio" id="custom" class="formatPref radio-inline"   name="formatPref" value="custom"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Custom</label>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- form for date -->
                    <div id="formDate" class="form-horizontal" style="display:none">

                        <div class="container">
                            <div class="row">
                                <div class="col-lg-10">
                                    <div class="col-lg-3" style="width:auto; margin-top:10px; margin-left: -15px;">
                                        Date format preference:
                                    </div>
                                    <div class="btn-group btn-group-horizontal" data-toggle="buttons">

                                        <label id="itlbl" class="datePreflbl btn"><input type="radio" id="it" class="datePref radio-inline"  name="datePref" value="it"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>DD/MM/YYYY</label>

                                        <label id="enlbl" class="datePreflbl btn"><input type="radio" id="en" class="datePref radio-inline"  name="datePref" value="en"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>MM/DD/YYYY</label>

                                        <label id="datalbl" class="datePreflbl btn"><input type="radio" id="data" class="datePref radio-inline"  name="datePref" value="data"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>YYYY-MM-DD</label>

                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- form for numbers -->
                    <div id="formNumber" class="form-horizontal" style="display:none">

                        <div class="container">
                            <div class="row">
                                <div class="col-lg-12">
                                    Numbers:
                                    <div class="btn-group btn-group-horizontal" data-toggle="buttons">

                                        <label id="commalbl" class="numberPreflbl btn"><input type="radio" id="comma" name="numberPref" class="numberPref radio-inline" value="comma"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Use comma for numbers (23,45)</label>

                                        <label id="pointlbl" class="numberPreflbl btn"><input type="radio" id="point" name="numberPref" class="numberPref radio-inline" value="point"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Use dot for numbers (23.45)</label>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- form for separators -->
                    <div id="formSeparator" class="form-horizontal" style="display:none;">

                        <div class="container">
                            <div class="row">
                                <div class="col-lg-12">
                                    Separator:
                                    <div class="btn-group btn-group-horizontal" data-toggle="buttons">
                                        <label id="comlbl" class="sepPreflbl btn"><input type="radio" id="com" name="sepPref" class="sepPref radio-inline" value="com"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Comma</label>

                                        <label id="tablbl" class="sepPreflbl btn"><input type="radio" id="tab" name="sepPref" class="sepPref radio-inline" value="tab"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Tabulation</label>

                                        <label id="colonlbl" class="sepPreflbl btn"><input type="radio" id="colon" name="sepPref" class="sepPref radio-inline" value="colon"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Semicolon</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- form for OS -->
                    <div id="formOs" class="form-horizontal">

                        <div class="container">
                            <div class="row">
                                <div class="col-lg-12">
                                    Operative system:
                                    <div class="btn-group btn-group-horizontal" data-toggle="buttons">
                                        <label id="winlbl" class="osPreflbl btn"><input type="radio" id="win" name="osPref" class="osPref radio-inline" value="win"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Windows</label>

                                        <label id="maclbl" class="osPreflbl btn"><input type="radio" id="mac" name="osPref" class="osPref radio-inline" value="mac"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Mac</label>

                                        <label id="linlbl" class="osPreflbl btn"><input type="radio" id="lin" name="osPref" class="osPref radio-inline" value="lin"><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Linux</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div style="padding-bottom: 55px;">
                        <div id="OS" style="margin-left: 7px;">* Your location</div>
                        <div style="margin-left: 1px;">** Your operative system</div>
                    </div>
                </form>
                <div class="row">
                    <div class="col-lg-12 loader" id="load" style="display:none;">
                    </div>
                </div>
                <!-- buttons -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btnClose" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-info btnExport" id="ex" onClick="storage()" data-dismiss="modal">Export</button>
                </div>

                <div class="container">

                </div>

            </div>

        </div>
    </div>
</body>
<script>
    function openForm() {
        $('#myModal').modal('show');

        if (opened === false) {
            opened = true;
            detectLocale();

            //load the preferences from the local Storage
            formatPref = window.localStorage.getItem("formatPref");
            datePref = window.localStorage.getItem("datePref");
            numberPref = window.localStorage.getItem("numberPref");
            osPref = window.localStorage.getItem("osPref");
            sepPref = window.localStorage.getItem("sepPref");

            if (formatPref != null) {
                setTimeout(function() {
                    if (formatPref == "custom") {
                        show(); //if format custom show the hidden fields
                    }
                    //turning actives with the local storage

                    inactivate();

                    $("#" + formatPref).prop("checked", true);
                    $("#" + datePref).prop("checked", true);
                    $("#" + numberPref).prop("checked", true);
                    $("#" + sepPref).prop("checked", true);

                    document.getElementById(formatPref + "lbl").className += ' active';
                    document.getElementById(datePref + "lbl").className += ' active';
                    document.getElementById(numberPref + "lbl").className += ' active';
                    document.getElementById(sepPref + "lbl").className += ' active';

                    OSrec();
                }, 200)
            }
            else {

                OSrec();
                //turning actives by default without local storage
                document.getElementById("europelbl").className = 'usalbl btn active';
                document.getElementById("enlbl").className = 'onlbl btn active';
                document.getElementById("pointlbl").className = 'pointlbl btn active';
                document.getElementById("winlbl").className = 'winlbl btn active';
                document.getElementById("comlbl").className = 'comlbl btn active';

                $("#europe").prop("checked", true);
                $("#en").prop("checked", true);
                $("#point").prop("checked", true);
                $("#win").prop("checked", true);
                $("#com").prop("checked", true);
            }
        }
    };

    //recognize the operative system
    function OSrec() {
        if (navigator.appVersion.indexOf("Win") != -1) {
            document.getElementById("winlbl").className = 'btn active';
            document.getElementById("winlbl").innerHTML = '<input type="radio" id="windows" name="osPref" class="osPref radio-inline" value="win" checked=true><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Windows**';
        }
        if (navigator.appVersion.indexOf("Mac") != -1) {
            document.getElementById("maclbl").className = 'btn active';
            document.getElementById("maclbl").innerHTML = '<input type="radio" id="mac" name="osPref" class="osPref radio-inline" value="mac" checked=true><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Mac**';
        }
        if (navigator.appVersion.indexOf("Linux") != -1) {
            document.getElementById("linlbl").className = 'btn active';
            document.getElementById("linlbl").innerHTML = '<input type="radio" id="linux" name="osPref" class="osPref radio-inline" value="lin" checked=true><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Linux**';
        }
    }

    function show() {
        //show the hidden fields
        document.getElementById('formDate').style.display = "";
        document.getElementById('formNumber').style.display = "";
        document.getElementById('formSeparator').style.display = "";
    }

    function hidde(param) {
        switch (param) {

            case "usa":
                //on selected option "usa" hide fields and check the ones for usa
                $("#en").prop("checked", true);
                $("#point").prop("checked", true);
                $("#com").prop("checked", true);

                document.getElementById("datalbl").className = 'btn';
                document.getElementById("itlbl").className = 'btn';
                document.getElementById("commalbl").className = 'btn';
                document.getElementById("tablbl").className = 'btn';

                document.getElementById("enlbl").className = 'btn active';
                document.getElementById("pointlbl").className = 'btn active';
                document.getElementById("comlbl").className = 'btn active';
                break;

            case "europe":
                //on selected option "europe" hide fields and check the ones for eeu
                $("#it").prop("checked", true);
                $("#comma").prop("checked", true);
                $("#com").prop("checked", true);

                document.getElementById("datalbl").className = 'btn';
                document.getElementById("enlbl").className = 'btn';
                document.getElementById("pointlbl").className = 'btn';
                document.getElementById("tablbl").className = 'btn';

                document.getElementById("itlbl").className = 'btn active';
                document.getElementById("commalbl").className = 'btn active';
                document.getElementById("comlbl").className = 'btn active';
                break;
        }

        document.getElementById('formDate').style.display = "none";
        document.getElementById('formNumber').style.display = "none";
        document.getElementById('formSeparator').style.display = "none";
    }

    function storage() {
        //test if the browser uses localStorage and Storage de options
        if (typeof(Storage) != "undefined") {

            formatPref = document.getElementsByClassName("formatPref");
            osPref = document.getElementsByClassName("osPref");
            sepPref = document.getElementsByClassName("sepPref");
            //catch the selected option
            check = false;
            for (i = 0; i < formatPref.length && check == false; i++) {
                if (formatPref[i].checked == true) {
                    formatPref = formatPref[i].value;
                    check = true;
                }
            }

            switch (formatPref) {
                //pretederminate values for options "europe" "usa"
                case "europe":
                    datePref = "it";
                    numberPref = "comma";
                    break;
                case "usa":
                    datePref = "en"
                    numberPref = "point";
                    break;
                case "custom":
                    datePref = document.getElementsByClassName("datePref");
                    numberPref = document.getElementsByClassName("numberPref");
                    //catch the selected option
                    check = false;
                    for (i = 0; i < datePref.length && check == false; i++) {
                        if (datePref[i].checked == true) {
                            datePref = datePref[i].value;
                            check = true;
                        }
                    }
                    //catch the selected option
                    check = false;
                    for (i = 0; i < numberPref.length && check == false; i++) {
                        if (numberPref[i].checked == true) {
                            numberPref = numberPref[i].value;
                            check = true;
                        }
                    }

                    break;
            }
            //catch the selected option
            check = false;
            for (i = 0; i < osPref.length && check == false; i++) {
                if (osPref[i].checked == true) {
                    osPref = osPref[i].value;
                    check = true;
                }
            }
            //catch the selected option
            check = false;
            for (i = 0; i < sepPref.length && check == false; i++) {
                if (sepPref[i].checked == true) {
                    sepPref = sepPref[i].value;
                    check = true;
                }
            }
            //saving localStorage
            window.localStorage.setItem("formatPref", formatPref);
            window.localStorage.setItem("datePref", datePref);
            window.localStorage.setItem("numberPref", numberPref);
            window.localStorage.setItem("osPref", osPref);
            window.localStorage.setItem("sepPref", sepPref);

            send();
        }
    }

    //send current options
    function send() {
        //send modal form to php
        document.forms['myForm'].submit();
        //change the button and wait for 0.5 secs until it fade out
        document.getElementById('ex').innerHTML = "Exporting...";
        document.getElementById('ex').disabled = true;
        document.getElementById("myForm").style.display = "none";
        document.getElementById('load').style.display = "";

        setTimeout(function() {
            setTimeout(function() {
                document.getElementById('ex').disabled = false;
                document.getElementById('ex').innerHTML = "Export";
                document.getElementById('load').style.display = "none";
                document.getElementById("myForm").style.display = "";
            }, 500);
            $('#myModal').modal('hide');
        }, 3000);

    }

    function inactivate() {

        //unselect all the fields for a clear reset of the form
        document.getElementById('usalbl').className = 'btn';
        document.getElementById("datalbl").className = 'btn';
        document.getElementById("enlbl").className = 'btn';
        document.getElementById("pointlbl").className = 'btn';
        document.getElementById("tablbl").className = 'btn';
        document.getElementById("europelbl").className = 'btn';
        document.getElementById("itlbl").className = 'btn';
        document.getElementById("commalbl").className = 'btn';
        document.getElementById("comlbl").className = 'btn';

        $("#europe").prop("checked", false);
        $("#it").prop("checked", false);
        $("#comma").prop("checked", false);
        $("#com").prop("checked", false);
        $("#usa").prop("checked", false);
        $("#en").prop("checked", false);
        $("#point").prop("checked", false);

    }

    function showPosition(position) {

        //calculate side of the map you are
        if (position.coords.longitude > -25.8895809) {

            //position for europe
            inactivate();
            $("#europe").prop("checked", true);
            $("#it").prop("checked", true);
            $("#comma").prop("checked", true);
            $("#com").prop("checked", true);

            document.getElementById("europelbl").innerHTML = '<input type="radio" onclick="hidde("europe")" id="europe" class="formatPref radio-inline"  name="formatPref" value="europe" checked=true><i class="fa fa-circle-o"></i><i class="fa fa-dot-circle-o"></i>Europe*';
            document.getElementById("europelbl").className = 'btn active';
            document.getElementById("itlbl").className = 'btn active';
            document.getElementById("commalbl").className = 'btn active';
            document.getElementById("comlbl").className = 'btn active';
        }
        else {
            //position for USA
            inactivate();
            $("#usa").prop("checked", true);
            $("#en").prop("checked", true);
            $("#point").prop("checked", true);
            $("#com").prop("checked", true);

            document.getElementById("usalbl").innerHTML = '<input type="radio" id="usa" onclick="hidde("usa")" class="formatPref radio-inline"  name="formatPref" value="usa" checked><i class="fa fa-circle-o" checked=true></i><i class="fa fa-dot-circle-o"></i>USA*';
            document.getElementById("usalbl").className = 'btn active';
            document.getElementById("enlbl").className = 'btn active';
            document.getElementById("pointlbl").className = 'btn active';
            document.getElementById("comlbl").className = 'btn active';
        }
    }

    function detectLocale() {
        //catch position of your connection
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        }
        else {
            document.getElementById("OS").innerHTML = "Geolocation is not supported by this browser.";
        }
    }
</script>

</html>
